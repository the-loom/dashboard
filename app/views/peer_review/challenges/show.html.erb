<% nav_add 'Desafíos', peer_review_challenges_path %>
<% nav_add @challenge.title, '#' %>
<%= nav_render4 %>


<% unless @challenge.reviews.where(reviewer: current_user, status: :draft).empty? %>

  <div class="alert alert-danger">
    <p>
      <strong>¡Cuidado!</strong> Tenés una revisión no publicada. Tomate tu tiempo, pero publicala para que otro
      participantes puedan verla.
    </p>
  </div>

<% end %>

<div id="wording" class="show">
  <h2>Consigna</h2>
  <%== @challenge.instructions %>
</div>

<br>

<div style="text-align: right;">
  <a data-toggle="collapse" href="#wording" role="button" aria-expanded="false" aria-controls="wording">
    Ocultar/mostrar consigna
  </a>
</div>

<hr/>

<% if @challenge.team_challenge && !current_user.current_membership.team %>
  <div class="alert alert-danger">
    <p>
      <strong>¡Oops!</strong>
      No podés resolver este desafío hasta que no tengas un equipo.
    </p>
  </div>
<% end %>

<% if @challenge.enabled? && (current_user.current_membership.team || !@challenge.team_challenge) %>

  <% if @challenge.team_challenge %>
    <div class="alert alert-info">
      <p>
        <strong>¡Atención!</strong>
        Esta tarea se resuelve por equipos. La estás resolviendo junto a
        <strong><%= current_user.current_membership.team.members.map(&:short_name).join(", ") %></strong>
        para el equipo <strong><%= current_user.current_membership.team.name %></strong>.
      </p>
      <p>La última edición la realizó <strong><%= @solution.author.short_name %></strong>
        (<%= @solution.updated_at.in_time_zone('Buenos Aires').strftime("%d/%m/%Y %H:%M") %>)</p>
    </div>
  <% end %>

  <p>
    <%= link_to 'Resolver', new_peer_review_challenge_solution_path(@challenge.id), class: 'btn btn-large btn-primary', disabled: !@challenge.solvable_by?(current_user) %>
    <%= link_to 'Revisar alguna solución', new_peer_review_challenge_review_path(@challenge.id), class: 'btn btn-large btn-primary', disabled: !@challenge.reviewable_by?(current_user) %>

    <% if @solution && policy(@solution).unpublish? %>
      <%= link_to 'Despublicar solución', unpublish_peer_review_challenge_solution_path(@challenge.id, @solution), method: :post, class: 'btn btn-large btn-warning', disabled: !@challenge.reviewable_by?(current_user) %>
    <% end %>
  </p>

<% end %>



<nav>
  <div class="nav nav-tabs" id="nav-tab" role="tablist">
    <a class="nav-item nav-link active" id="nav-solution-tab" data-toggle="tab" href="#nav-solution" role="tab" aria-controls="nav-solution" aria-selected="true">Mi
      solución</a>
    <a class="nav-item nav-link" id="nav-reviews-tab" data-toggle="tab" href="#nav-reviews" role="tab" aria-controls="nav-reviews" aria-selected="false">Revisiones realizadas</a>
    <a class="nav-item nav-link" id="nav-examples-tab" data-toggle="tab" href="#nav-examples" role="tab" aria-controls="nav-examples" aria-selected="false">Soluciones
      sugeridas</a>
  </div>
</nav>
<div class="tab-content" id="nav-tabContent">
  <div class="tab-pane fade show active" id="nav-solution" role="tabpanel" aria-labelledby="nav-solution-tab">
    <% unless @solution.present? %>
      <div class="alert alert-info">
        <p>Aún no resolviste este desafío.</p>
      </div>
    <% else %>
      <%= render partial: '/peer_review/solution_wording', locals: {source_code: @challenge.source_code?, wording: @solution.wording, language: @challenge.language} %>

      <% if @challenge.allows_attachment? %>
        <div>
          <% document = @solution.solution_attachment %>
          <% if document.attached? %>
            <p>Adjunto:</p>
            <%= link_to rails_blob_path(document, disposition: 'preview') do %>
              <i class="fa fa-paperclip"></i>
              <%= document.filename %>
            <% end %>
          <% end %>
        </div>
      <% end %>

      <br>

      <% if @solution.draft? %>

        <div class="alert alert-info">
          <p>
            Cuando consideres que tu solución está presentable... ¡publicala! Así podrás recibir revisiones, y revisar
            las
            soluciones de otros participantes.
          </p>
        </div>

      <% else %>

        <h3>Revisiones Recibidas</h3>
        <% if @solution.reviews.final.empty? %>
          <div class="alert alert-info">
            <p>Tu solución aún no ha recibido revisiones.</p>
          </div>
        <% else %>
          <div class="row">
            <div class="col-2">
              <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                <% @solution.reviews.where(status: :final).each_with_index do |review, index| %>
                  <a href="#<%= "review_#{index}" %>" id="#<%= "review_#{index}" %>" class="nav-link<%= ' active' if index == 0 %>"
                     aria-controls="#<%= "review_#{index}" %>" role="tab" data-toggle="pill" aria-selected="<%= index == 0 %>">
                    <%= "Revisión ##{index + 1}" %>
                    <% if review.reviewer.teacher? %>
                      (docente)
                    <% end %>
                  </a>
                <% end %>
              </div>
            </div>
            <div class="col-10">
              <div class="tab-content" id="v-pills-tabContent">
                <% @solution.reviews.where(status: :final).each_with_index do |review, index| %>
                  <div class="tab-pane fade <%= 'show active' if index == 0 %>" id="<%= "review_#{index}" %>" role="tabpanel" aria-labelledby="<%= "review_#{index}" %>">
                    <% if review.reviewer.teacher? %>
                      <h4>Revisión realizada por <%= review.reviewer.full_name %></h4>
                    <% end %>
                    <div class="well">
                      <%= render partial: '/peer_review/review_wording', locals: {quick_review: @challenge.allows_quick_reviews?, wording: review.wording} %>
                    </div>
                    <%= render partial: 'assessment', locals: {review: review} %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
        <br>
      <% end %>
    <% end %>
  </div>

  <div class="tab-pane fade" id="nav-reviews" role="tabpanel" aria-labelledby="nav-reviews-tab">
    <% if @challenge.reviews.where(reviewer: current_user).empty? %>
      <div class="alert alert-info">
        <p>No realizaste revisiones aún.</p>
      </div>
    <% else %>
      <div class="row">
        <div class="col-2">
          <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
            <% @challenge.reviews.where(reviewer: current_user).each_with_index do |review, index| %>
              <a href="#<%= "rreview_#{index}" %>" id="#<%= "rreview_#{index}" %>" class="nav-link<%= ' active' if index == 0 %>"
                 aria-controls="#<%= "rreview_#{index}" %>" role="tab" data-toggle="pill" aria-selected="<%= index == 0 %>">
                <%= "Revisión ##{index + 1}" %>
                <% if review.reviewer.teacher? %>
                  (docente)
                <% end %>
              </a>
            <% end %>
          </div>
        </div>
        <div class="col-10">
          <div class="tab-content" id="v-pills-tabContent">
            <% @challenge.reviews.where(reviewer: current_user).each_with_index do |review, index| %>
              <div class="tab-pane fade <%= 'show active' if index == 0 %>" id="<%= "rreview_#{index}" %>" role="tabpanel" aria-labelledby="<%= "rreview_#{index}" %>">

                <h3>Solución revisada</h3>
                <%= render partial: '/peer_review/solution_wording', locals: {source_code: @challenge.source_code?, wording: review.solution.wording, language: @challenge.language} %>
                <% if @challenge.allows_attachment? %>
                  <div>
                    <% document = review.solution.solution_attachment %>
                    <% if document.attached? %>
                      <p>Adjunto:</p>
                      <%= link_to rails_blob_path(document, disposition: 'preview') do %>
                        <i class="fa fa-paperclip"></i>
                        <%= document.filename %>
                      <% end %>
                    <% end %>
                  </div>
                <% end %>

                <h3>Mi revisión</h3>

                <div class="well">
                  <%= render partial: '/peer_review/review_wording', locals: {quick_review: @challenge.allows_quick_reviews?, wording: review.wording} %>
                </div>

                <%= render partial: 'assessment', locals: {review: review} %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <div class="tab-pane fade" id="nav-examples" role="tabpanel" aria-labelledby="nav-examples-tab">
    <% unless @challenge.has_picked_solutions? %>
      <div class="alert alert-info">
        <p>Aún no hay soluciones sugeridas.</p>
      </div>
    <% else %>
      <div class="row">
        <div class="col-2">
          <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
            <% @challenge.picked_solutions.each_with_index do |_, index| %>
              <a href="#<%= "ssolution_#{index}" %>" id="#<%= "ssolution_#{index}" %>" class="nav-link<%= ' active' if index == 0 %>"
                 aria-controls="#<%= "ssolution_#{index}" %>" role="tab" data-toggle="pill" aria-selected="<%= index == 0 %>">
                <%= "Solución ##{index + 1}" %>
              </a>
            <% end %>
          </div>
        </div>
        <div class="col-10">
          <div class="tab-content" id="v-pills-tabContent">
            <% @challenge.picked_solutions.each_with_index do |solution, index| %>
              <div class="tab-pane fade <%= 'show active' if index == 0 %>" id="<%= "ssolution_#{index}" %>" role="tabpanel" aria-labelledby="<%= "ssolution_#{index}" %>">
                <% if @challenge.allows_attachment? %>
                  <div>
                    <% document = solution.solution_attachment %>
                    <% if document.attached? %>
                      <p>
                        Adjunto:
                        <%= link_to rails_blob_path(document, disposition: 'preview') do %>
                          <i class="fa fa-paperclip"></i>
                          <%= document.filename %>
                        <% end %>
                      </p>
                    <% end %>
                  </div>
                <% end %>

                <%= render partial: '/peer_review/solution_wording', locals: {source_code: @challenge.source_code?, wording: solution.wording, language: @challenge.language} %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>


<% content_for :head do %>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/trix/0.12.0/trix.css" rel="stylesheet">
  <style><%= ::Rouge::Themes::Base16.mode(:dark).render(scope: '.highlight') %></style>
<% end %>
