<%= render partial: 'header', locals: {repo: @repo} %>

<% if @repo.parent %>

  <section class="results">
    <h2>
      Resultados de la última entrega: <span class="badge score pull-right"><%= @repo.latest_test_run.score %></span>
    </h2>

    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
      <% @repo.latest_test_run.results.each_with_index do |result, index| %>
        <div class="panel panel-default">
          <div class="panel-heading" role="tab" id="heading<%= result.test_type.capitalize %>">
            <h4 class="panel-title">
              <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse<%= result.test_type.capitalize %>" aria-expanded="true" aria-controls="collapseOne">
                <div class="progress tiny pull-right">
                  <div class="progress-bar progress-bar" role="progressbar" aria-valuenow="<%= result.score %>" aria-valuemin="0" aria-valuemax="100" style="width: <%= result.score * 10 %>%">
                  </div>
                </div>
                Resultados para <%= result.test_type.capitalize %>
                <span class="small">(<%= result.issues.count %> incidencias)</span>
              </a>
            </h4>
          </div>
          <div id="collapse<%= result.test_type.capitalize %>" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="heading<%= result.test_type.capitalize %>">
            <div class="panel-body">

              <table class="table table-hover">
                <thead>
                <tr>
                  <th>Mensaje</th>
                  <th>Detalles</th>
                </tr>
                </thead>
                <tbody>
                <% result.issues.each do |issue| %>
                  <tr>
                    <td>
                      <span class="label label-warning"><%= issue.issue_type %></span>
                      <%= issue.message %>
                    </td>
                    <td>
                      <pre><%= issue.details %></pre>

                      <% if issue.payload %>
                        <div class="bs-callout bs-callout-info">
                          <h4>Información adicional</h4>
                          <dl class="dl-horizontal">
                            <% issue.payload.each do |key, value| %>
                              <dt><%= t key %>:</dt>
                              <dd><%= value %></dd>
                            <% end %>
                          </dl>
                        </div>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
                </tbody>
              </table>

            </div>
          </div>
        </div>
      <% end %>
    </div>
  </section>

<% else %>

  <section class="forks">
    <table class="table table-striped">
      <thead>
      <tr>
        <th>Autores</th>
        <th>Enlace</th>
        <th>Resultado</th>
      </tr>
      </thead>
      <tbody>
      <% @repo.forks.each do |fork| %>
        <tr class="fork">
          <td>
            <img class="avatar small" src="<%= fork.avatar_url %>" title="<%= fork.user %>" alt="<%= fork.user %>">
            <%= fork.user %>
          </td>
          <td>
            <%= link_to fork.full_name, repo_path(user: fork.user, name: fork.name) %>
          </td>
          <td>
            <div class="progress">
              <div class="progress-bar progress-bar-<%= fork.latest_test_run.score < 4 ? 'danger' : (fork.latest_test_run.score > 7 ? 'success' : 'warning') %>"
                   role="progressbar" aria-valuenow="<%= fork.latest_test_run.score * 10 %>"
                   aria-valuemin="0" aria-valuemax="100" style="width: <%= fork.latest_test_run.score * 10 %>%">
                <%= fork.latest_test_run.score %>/10
              </div>
            </div>
            <span class="time-ago" data-time="<%= fork.latest_test_run.created_at.to_i * 1000 %>">TIME AGO</span></td>
        </tr>
      <% end %>
      </tbody>
    </table>
  </section>

<% end %>


<% content_for :javascript do %>
  <script type="text/javascript" charset="utf-8">
      $(function () {
          $(".time-ago").each(function () {
              $(this).text(moment($(this).data('time')).fromNow());
              $(this).attr('title', moment($(this).data('time')).format('LLLL'));
          });
      })
  </script>
<% end %>

